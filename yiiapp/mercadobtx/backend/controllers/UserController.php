<?php
/**
 * CRUD for managing User models.
 *
 * This is the UserController verbatim generated using Gii module.
 * Almost no changes were done to the code.
 *
 * @package YiiBoilerplate\Backend
 */
class UserController extends BackendController {
	/**
	 * We override the layout to be two-column one.
	 * We'll put the CRUD menu in sidebar.
	 *
	 * @see http://www.yiiframework.com/doc/api/1.1/CController#layout-detail
	 *
	 * @var string Layout used for rendering views
	 */
	public $layout = '//layouts/column2';
	
	/**
	 * Additional behavior associated with different routes in the controller.
	 *
	 * We allow only POST requests to "delete" action, everything else is default for backend.
	 *
	 * @see http://www.yiiframework.com/doc/api/1.1/CController#filters-detail
	 * @see http://www.yiiframework.com/doc/api/1.1/CAccesControlFilter
	 * @see http://yii-booster.clevertech.biz/getting-started.html#initialization
	 *
	 * @return array
	 */
	public function filters() {
		return array_merge ( [ 
				[ 
						'postOnly + delete' 
				] 
		], parent::filters () );
	}
	
	/**
	 * Specifies the access control rules.
	 * This method is used by the 'accessControl' filter.
	 * 
	 * @return array access control rules
	 */
	public function accessRules() {
		return array (
				array (
						'allow', // allow all users to perform 'index' and 'view' actions
						'actions' => array (
								'index',
								'view' 
						),
						'users' => array (
								'admin' 
						) 
				),
				array (
						'allow', // allow authenticated user to perform 'create' and 'update' actions
						'actions' => array (
								'create',
								'update' 
						),
						'users' => array (
								'admin' 
						) 
				),
				array (
						'allow', // allow admin user to perform 'admin' and 'delete' actions
						'actions' => array (
								'admin',
								'delete' 
						),
						'users' => array (
								'admin' 
						) 
				),
				array (
						'deny', // deny all users
						'users' => array (
								'*' 
						) 
				) 
		);
	}
	
	/**
	 * Displays a particular model.
	 * 
	 * @param integer $id
	 *        	the ID of the model to be displayed
	 */
	public function actionView($id) {
		$model = $this->loadModel ( $id );
		$this->render ( 'view', compact ( 'model' ) );
	}
	
	/**
	 * Creates a new model.
	 * If creation is successful, the browser will be redirected to the 'view' page.
	 */
	public function actionCreate() {
		$model = new User ();
		
		// Uncomment the following line if AJAX validation is needed
		// $this->performAjaxValidation($model);
		
		if (isset ( $_POST ['User'] )) {
			$model->attributes = $_POST ['User'];
			if ($model->save ())
				$this->redirect ( array (
						'view',
						'id' => $model->id 
				) );
		}
		
		$this->render ( 'create', compact ( 'model' ) );
	}
	
	/**
	 * Updates a particular model.
	 * If update is successful, the browser will be redirected to the 'view' page.
	 * 
	 * @param integer $id
	 *        	the ID of the model to be updated
	 */
	public function actionUpdate($id) {
		$model = $this->loadModel ( $id );
		
		// Uncomment the following line if AJAX validation is needed
		// $this->performAjaxValidation($model);
		$request = Yii::app ()->request;
		$formData = $request->getPost ( get_class ( $model ), false );
		
		/* TODO
		 * Display a lint to s3 URL
		 *
		$s3_dirname = sprintf('userid_%s', $model->id);
		$s3 = new S3(Yii::app()->params['s3d']['access_key'], Yii::app()->params['s3d']['secret_key']);
		
		$s3url = $s3->getBucketLocation('mbtx');
			*/
		$s3url = '#';
			
		if ($formData) {
			$model->attributes = $formData;
			if (array_key_exists ( 'save', $formData )) {
				if ($model->save ()) {
					$this->redirect ( array (
							'index' 
					) );
				}
			}
			elseif (array_key_exists ( 'verify', $formData )) {
				if ( $model->verify ) {
					$model->verify->delete();
				}
				else {
					$newv = new UserVerify();
					$newv->id_user = $model->id;
					if (!$newv->save ()) {
						Yii::app ()->user->setFlash ( 'error', Yii::t ( 'translation', 'Unable to verify user' ) );
					}
				}
				$this->redirect ( array (
						'index'
				) );
			}
			elseif (array_key_exists ( 'activate', $formData )) {
				if ( $model->activation_time ) {
					$model->activation_time = 0;
				}
				else {
					$model->activation_time = time();
				}
				if ($model->save ()) {
					$this->redirect ( array (
							'index'
					) );
				}
			}
		}
		
		$this->render ( 'update', compact ( 'model', 's3url') );
	}
	
	/**
	 * Deletes a particular model.
	 * If deletion is successful, the browser will be redirected to the 'admin' page.
	 * 
	 * @param integer $id
	 *        	the ID of the model to be deleted
	 */
	public function actionDelete($id) {
		$this->loadModel ( $id )->delete ();
		
		// if AJAX request (triggered by deletion via admin grid view), we should not redirect the browser
		if (! isset ( $_GET ['ajax'] ))
			$this->redirect ( isset ( $_POST ['returnUrl'] ) ? $_POST ['returnUrl'] : array (
					'admin' 
			) );
	}
	
	/**
	 * Lists all models.
	 */
	public function actionIndex() {
		$dataProvider = new CActiveDataProvider ( 'User' );
		$this->render ( 'index', compact ( 'dataProvider' ) );
	}
	
	/**
	 * Manages all models.
	 */
	public function actionAdmin() {
		$model = new User ( 'search' );
		$model->unsetAttributes (); // clear any default values
		if (isset ( $_GET ['User'] ))
			$model->attributes = $_GET ['User'];
		
		$this->render ( 'admin', compact ( 'model' ) );
	}
	
	/**
	 * Returns the data model based on the primary key given in the GET variable.
	 * If the data model is not found, an HTTP exception will be raised.
	 * 
	 * @param integer $id
	 *        	the ID of the model to be loaded
	 * @return User the loaded model
	 * @throws CHttpException
	 */
	public function loadModel($id) {
		$model = User::model ()->findByPk ( $id );
		if ($model === null)
			throw new CHttpException ( 404, 'The requested page does not exist.' );
		return $model;
	}
	
	/**
	 * Performs the AJAX validation.
	 * 
	 * @param User $model
	 *        	the model to be validated
	 */
	protected function performAjaxValidation($model) {
		if (isset ( $_POST ['ajax'] ) && $_POST ['ajax'] === 'user-form') {
			echo CActiveForm::validate ( $model );
			Yii::app ()->end ();
		}
	}
}
